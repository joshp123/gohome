# RFC: Reverse Proxy + Index Landing Page

- Date: 2025-12-31
- Status: Implemented
- Audience: operators, users, infra engineers

## 1) Narrative: what we are building and why

GoHome should be reachable via **one saved URL** so humans never need to remember
ports. A small reverse proxy handles routing to Grafana, VictoriaMetrics, and
GoHome’s HTTP endpoints, and serves a simple index page that links to all services.
This improves usability without changing core architecture.

## 1.1) Non‑negotiables

- Single base URL for humans (no port memorization)
- Tailscale‑only access (no public exposure)
- No UI framework or app; a static index page only
- Reverse proxy must be Nix‑managed

## 2) Goals / Non‑goals

Goals:
- Base URL `http://gohome` (MagicDNS) serves index + links
- Subpaths for services (`/grafana`, `/vm`, `/gohome`)
- Minimal operational complexity

Non‑goals:
- Public TLS termination or public ingress
- Auth layer beyond Tailscale in MVP
- gRPC‑web or browser access to gRPC services

## 3) System overview

Nginx (NixOS module) listens on port 80 on the tailnet interface. It serves a
static index HTML and reverse‑proxies subpaths to internal services.

## 4) Components and responsibilities

- Nginx: reverse proxy + static index
- GoHome HTTP server: health, metrics, dashboards
- Grafana: web UI (served from subpath)
- VictoriaMetrics: web UI (served from subpath)

## 5) Inputs / workflow profiles

Inputs:
- MagicDNS name (e.g., `gohome`)
- Local service ports (GoHome HTTP 8080, Grafana 3000, VM 8428)

Validation rules:
- Index page must load at base URL
- Subpaths must function without remembering ports

## 6) Artifacts / outputs

- Static `index.html` served at `/`
- Nginx reverse proxy configuration

## 7) State machine (if applicable)

Not applicable.

## 8) API surface (protobuf)

No protobuf changes.

## 9) Interaction model

User opens `http://gohome` and clicks:
- Grafana → `/grafana/`
- VictoriaMetrics → `/vm/`
- GoHome HTTP endpoints → `/gohome/`

## 10) System interaction diagram

```
Browser
  | http://gohome
  v
Nginx
  | /grafana/ -> Grafana
  | /vm/      -> VictoriaMetrics
  | /gohome/  -> GoHome HTTP
```

## 11) API call flow (detailed)

1) Browser requests `/`
2) Nginx serves static index.html
3) User clicks a link
4) Nginx proxies to the upstream service

## 12) Determinism and validation

- Nginx config is generated by Nix
- Index HTML is versioned in repo and deployed by Nix
- Grafana and VictoriaMetrics are configured for subpath operation

## 13) Outputs and materialization

Primary output is a base URL with a static landing page and proxies.

## 14) Testing philosophy and trust

- Smoke test: open `http://gohome` over Tailscale
- Verify each subpath loads and renders

## 15) Incremental delivery plan

1) Add index.html + nginx config
2) Configure Grafana `serve_from_sub_path = true`
3) Configure VictoriaMetrics path prefix

## 16) Implementation order

1) Add `web/index.html` to repo
2) Add Nginx config in NixOS module
3) Update Grafana + VM settings for subpaths

## 16.1) Dependencies / sequencing

- Dependencies: Nix-native config/build; deployment boundary (Tailscale‑only)
- Blocks: human‑friendly access without port memorization
- Next: add Nginx module + index page

## 17) Brutal self‑review (required)

- Junior engineer: Is the path map obvious? Yes; `/grafana`, `/vm`, `/gohome`.
- Mid‑level engineer: Does this add operational risk? Low; Nginx is standard and
  managed by Nix.
- Senior/principal engineer: Are we ignoring gRPC? Yes; gRPC stays on its port in
  MVP. If we want a single‑port gRPC gateway later, it needs its own RFC.
- PM: Does this improve usability? Yes, a single URL is the simplest mental model.
- EM: Is this maintainable? Yes, small config + static file.
- External stakeholder: Any security change? No; Tailscale boundary unchanged.
- End user: Can I find what I need fast? Yes; index links are immediate.
